	DECLARE @AsoPPTemp dbo.TAsoPP;

	INSERT INTO @AsoPPTemp(
		ValDocPersona, --Guarda el nombre del tipo de Uso/Zona, no el Id
		NumFinca,
		TipoAsociacion)
	SELECT A.ValorDocumentoIdentidad,
		A.NumeroFinca,
		A.TipoAsociacion
	FROM OPENXML (@hdoc, @nodoAsoPP, 1)
	WITH (ValorDocumentoIdentidad INT,
		NumeroFinca INT,
		TipoAsociacion VARCHAR(16)) AS A;

	DECLARE @ValDocPersona INT;
	DECLARE @TipoAsociacion VARCHAR(16);
	DECLARE @AsoPPFinalIndex INT = (SELECT MAX(Id) FROM @AsoPPTemp);
	DECLARE @AsoPPIndex INT = 1;
	WHILE (@AsoPPFinalIndex >= @AsoPPIndex)
	BEGIN
		SET @ValDocPersona = (SELECT ValDocPersona FROM @AsoPPTemp WHERE Id = @AsoPPIndex);
		SET @NumFinca = (SELECT NumFinca FROM @AsoPPTemp WHERE Id = @AsoPPIndex);
		SET @TipoAsociacion = (SELECT TipoAsociacion FROM @AsoPPTemp WHERE Id = @AsoPPIndex);
		--Si TipoAsociación es 1 (Agregar) inserta en la tabla PersonaXPropiedad
		IF (@TipoAsociacion = 'Agregar')
		BEGIN
			IF ((EXISTS (SELECT 1 FROM dbo.Persona WHERE ValorDocumentoIdentidad = @ValDocPersona))
				AND (EXISTS (SELECT 1 FROM dbo.Propiedad WHERE NumeroFinca = @NumFinca)))
			BEGIN 
				INSERT INTO dbo.PersonaXPropiedad (
					IdPersona,
					IdPropiedad,
					FechaInicio)
				SELECT PE.Id,
					PR.Id,
					@Date
				FROM dbo.Persona AS PE,
					dbo.Propiedad AS PR
				WHERE PE.ValorDocumentoIdentidad = @ValDocPersona
					AND PR.NumeroFinca = @NumFinca;
			END;
		END;
		--Si TipoAsociación es 2 (Eliminar) actualiza la FechaFin de la asociación
		ELSE
		BEGIN
			UPDATE dbo.PersonaXPropiedad
			SET FechaFin = @Date
			FROM dbo.PersonaXPropiedad AS PP
				INNER JOIN dbo.Persona AS PE ON PE.Id = PP.IdPersona
				INNER JOIN dbo.Propiedad AS PR ON PR.Id = PP.IdPropiedad
			WHERE PE.ValorDocumentoIdentidad = @ValDocPersona
				AND PR.NumeroFinca = @NumFinca;
		END;

		SET @AsoPPIndex = @AsoPPIndex + 1;
	END; --Fin del WHILE para PersonaXPropiedad
	DELETE @AsoPPTemp;


	<Catalogo>
  <TipodeMovimientoLecturadeMedidor>
    <TipodeMovimientoLecturadeMedidor id = "1" Nombre = "Lectura" />
    <TipodeMovimientoLecturadeMedidor id = "2" Nombre = "Ajuste Credito" />
    <TipodeMovimientoLecturadeMedidor id = "3" Nombre = "Ajuste Debito" />
  </TipodeMovimientoLecturadeMedidor>
  <TipoUsoPropiedad>
    <TipoUsoPropiedad id = "1" Nombre = "Habitacion" />
    <TipoUsoPropiedad id = "2" Nombre = "Comercial" />
    <TipoUsoPropiedad id = "3" Nombre = "Industrial" />
    <TipoUsoPropiedad id = "4" Nombre = "Lote baldio" />
    <TipoUsoPropiedad id = "5" Nombre = "Agricola" />
  </TipoUsoPropiedad>
  <TipoZonaPropiedad>
    <TipoZonaPropiedad id = "1" Nombre = "Residencial" />
    <TipoZonaPropiedad id = "2" Nombre = "Agricola" />
    <TipoZonaPropiedad id = "3" Nombre = "Bosque" />
    <TipoZonaPropiedad id = "4" Nombre = "Zona industrial" />
    <TipoZonaPropiedad id = "5" Nombre = "Zona comercial" />
  </TipoZonaPropiedad>
  <TipoDocumentoIdentidad>
    <TipoDocumentoIdentidad id = "1" Nombre = "Cedula CR" />
    <TipoDocumentoIdentidad id = "2" Nombre = "Persona Jurídica CR" />
    <TipoDocumentoIdentidad id = "3" Nombre = "Pasaporte CR" />
  </TipoDocumentoIdentidad>
  <TipoUsuario>
    <TipoUsuario id = "0" Nombre = "Administrador" />
    <TipoUsuario id = "1" Nombre = "Propietario" />
  </TipoUsuario>
  <TipoAsociacion>
    <TipoAsociacion id = "0" Nombre = "Eliminar" />
    <TipoAsociacion id = "1" Nombre = "Agregar" />
  </TipoAsociacion>
  <TipoMedioPago>
    <TipoMedioPago id = "0" Nombre = "Efectivo" />
    <TipoMedioPago id = "1" Nombre = "Transferencia bancaria" />
    <TipoMedioPago id = "2" Nombre = "Tarjeta bancaria" />
  </TipoMedioPago>
  <PeriodoMontoCC>
    <PeriodoMontoCC id = "1" Nombre = "Mensual" QMeses = "1" />
    <PeriodoMontoCC id = "2" Nombre = "Trimestral" QMeses = "3" />
    <PeriodoMontoCC id = "3" Nombre = "Semestral" QMeses = "6" />
    <PeriodoMontoCC id = "4" Nombre = "Anual" QMeses = "12" />
    <PeriodoMontoCC id = "5" Nombre = "Cobro Único no recurrente" QMeses = "1" />
  </PeriodoMontoCC>
  <TipoMontoCC>
    <TipoMontoCC id = "0" Nombre = "Monto Fijo" />
    <TipoMontoCC id = "1" Nombre = "Monto Variable" />
    <TipoMontoCC id = "2" Nombre = "MontoXPorcentaje" />
  </TipoMontoCC>
</Catalogo>



INSERT INTO dbo.ConceptoCobro (
		IdPeriodoMontoCC,
		IdTipoMonto,
		Nombre)
	VALUES (
		1,
		2,
		'Agua');


INSERT INTO dbo.ConceptoCobro (
		IdPeriodoMontoCC,
		IdTipoMonto,
		Nombre)
	VALUES (
		3,
		0,
		'Patente comercial');

INSERT INTO dbo.ConceptoCobro (
		IdPeriodoMontoCC,
		IdTipoMonto,
		Nombre)
	VALUES (
		4,
		2,
		'Impuesto sobre propiedad');

INSERT INTO dbo.ConceptoCobro (
		IdPeriodoMontoCC,
		IdTipoMonto,
		Nombre)
	VALUES (
		1,
		2,
		'Recolección de basura y limpieza de caños');

INSERT INTO dbo.ConceptoCobro (
		IdPeriodoMontoCC,
		IdTipoMonto,
		Nombre)
	VALUES (
		4,
		0,
		'Mantenimiento de parques'
	);

INSERT INTO dbo.ConceptoCobro (
		IdPeriodoMontoCC,
		IdTipoMonto,
		Nombre)
	VALUES (
		1,
		1,
		'Intereses moratorios en facturas vencidas');

INSERT INTO dbo.ConceptoCobro (
		IdPeriodoMontoCC,
		IdTipoMonto,
		Nombre)
	VALUES (
		5,
		0,
		'Reconexion Agua');